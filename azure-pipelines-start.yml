# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  - main
  - master

resources:
  - repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'e3aea656-c584-4bbf-9c21-ea617cbde3c7'
  imageRepository: 'central'
  containerRegistry: 'grizzlyentertainment.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/central/Dockerfile'
  tag: 'latest'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:

  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build
        pool: Relic Pool
        steps:
        
          - task: Gradle@3
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'jarAll'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              sonarQubeRunAnalysis: false
              spotBugsAnalysis: false

          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: 'central'
              dockerfile: '$(Build.SourcesDirectory)/central/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)


          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: 'channel'
              dockerfile: '$(Build.SourcesDirectory)/channel/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: 'realm'
              dockerfile: '$(Build.SourcesDirectory)/realm/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: 'proxy'
              dockerfile: '$(Build.SourcesDirectory)/proxy/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: 'world'
              dockerfile: '$(Build.SourcesDirectory)/world/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

          - task: CmdLine@2
            inputs:
              script: |
                docker run -d --name central -p 18650:18650/tcp -e "live=true" grizzlyentertainment.azurecr.io/central:latest
          
          - task: CmdLine@2
            inputs:
              script: |
                docker run -d --name channel -p 23451:23451/tcp -e "index=1" -e "live=true" grizzlyentertainment.azurecr.io/channel:latest

          - task: CmdLine@2
            inputs:
              script: |
                docker run -d --name realm -p 18751:18751/tcp -e "index=1" -e "live=true" grizzlyentertainment.azurecr.io/realm:latest

          - task: CmdLine@2
            inputs:
              script: |
                docker run -d --name proxy -p 18550:18550/tcp -e "index=1" -e "live=true" grizzlyentertainment.azurecr.io/proxy:latest

          - task: CmdLine@2
            inputs:
              script: |
                docker run -d --name valjar -p 18851:18851/tcp -e "index=1" -e "name=Valjar" -e "location=United-States" -e "type=Normal" -e "live=true" grizzlyentertainment.azurecr.io/world:latest

